name: Deploy to Hugging Face Spaces

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  HF_SPACE_REPO: ${{ secrets.HF_USERNAME }}/clinical-study-extraction

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: ðŸ” Run linting
        run: |
          pip install flake8
          flake8 backend/app --count --select=E9,F63,F7,F82 --show-source --statistics
        continue-on-error: true

      - name: ðŸ§ª Run tests
        run: |
          pip install pytest pytest-cov
          cd backend
          pytest tests/ --cov=app --cov-report=xml || true
        continue-on-error: true

  # Job 2: Deploy to Hugging Face Spaces (Production)
  deploy-production:
    name: Deploy to Hugging Face Spaces (Production)
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: ðŸ¤— Deploy to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          SPACE_NAME: clinical-study-extraction
        run: |
          set -e
          
          echo "ðŸ”§ Configuring git..."
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "GitHub Actions Bot"
          
          echo "ðŸ“¥ Cloning Hugging Face Space repository..."
          git clone https://huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME hf-space
          
          echo "ðŸ§¹ Cleaning Space repository..."
          cd hf-space
          rm -rf backend/ Dockerfile README.md .gitignore || true
          
          echo "ðŸ“‹ Copying files to Space..."
          cp -r ../backend .
          cp ../Dockerfile.huggingface Dockerfile
          cp ../README_HUGGINGFACE.md README.md
          
          echo "âœï¸ Creating .gitignore..."
          cat > .gitignore << 'EOF'
          __pycache__/
          *.py[cod]
          *$py.class
          *.so
          .Python
          build/
          develop-eggs/
          dist/
          downloads/
          eggs/
          .eggs/
          lib/
          lib64/
          parts/
          sdist/
          var/
          wheels/
          *.egg-info/
          .installed.cfg
          *.egg
          .env
          .venv
          env/
          venv/
          ENV/
          env.bak/
          venv.bak/
          .DS_Store
          .idea/
          .vscode/
          *.swp
          *.swo
          *~
          uploads/
          exports/
          cache/
          *.log
          EOF
          
          echo "ðŸ“ Checking for changes..."
          git add .
          
          if git diff --staged --quiet; then
            echo "âœ… No changes to deploy"
          else
            echo "ðŸš€ Committing and pushing changes..."
            git commit -m "ðŸš€ Auto-deploy from GitHub Actions

          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Author: ${{ github.actor }}
          Message: ${{ github.event.head_commit.message }}"
            
            git push https://USER:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME main
            
            echo "âœ… Deployment successful!"
          fi
          
          cd ..
          rm -rf hf-space

      - name: ðŸ“ Create deployment summary
        if: success()
        run: |
          echo "## ðŸš€ Deployment to Hugging Face Spaces Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Space:** ${{ secrets.HF_USERNAME }}/clinical-study-extraction" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Access URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Space URL:** https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/clinical-study-extraction" >> $GITHUB_STEP_SUMMARY
          echo "- **API Endpoint:** https://${{ secrets.HF_USERNAME }}-clinical-study-extraction.hf.space" >> $GITHUB_STEP_SUMMARY
          echo "- **API Docs:** https://${{ secrets.HF_USERNAME }}-clinical-study-extraction.hf.space/docs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Build Info" >> $GITHUB_STEP_SUMMARY
          echo "- Build time: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ’¬ Notify Slack on success
        if: success() && secrets.SLACK_WEBHOOK != ''
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: |
            âœ… Deployment to Hugging Face Spaces successful!
            Space: ${{ secrets.HF_USERNAME }}/clinical-study-extraction
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            URL: https://${{ secrets.HF_USERNAME }}-clinical-study-extraction.hf.space
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

      - name: ðŸ’¬ Notify Slack on failure
        if: failure() && secrets.SLACK_WEBHOOK != ''
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            âŒ Deployment to Hugging Face Spaces failed!
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # Job 3: Deploy to Staging Space (Develop branch)
  deploy-staging:
    name: Deploy to Staging Space (Develop)
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ¤— Deploy to Staging Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          SPACE_NAME: clinical-study-extraction-staging
        run: |
          set -e
          
          echo "ðŸ”§ Configuring git..."
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "GitHub Actions Bot"
          
          echo "ðŸ“¥ Cloning Staging Space..."
          git clone https://huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME hf-staging || {
            echo "âš ï¸ Staging space doesn't exist, skipping..."
            exit 0
          }
          
          echo "ðŸ“‹ Copying files..."
          cd hf-staging
          rm -rf backend/ Dockerfile README.md || true
          cp -r ../backend .
          cp ../Dockerfile.huggingface Dockerfile
          cp ../README_HUGGINGFACE.md README.md
          
          echo "ðŸš€ Deploying to staging..."
          git add .
          git commit -m "ðŸ§ª Staging deploy from develop branch" || exit 0
          git push https://USER:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME main
          
          cd ..
          rm -rf hf-staging

      - name: ðŸ“ Create staging summary
        if: success()
        run: |
          echo "## ðŸ§ª Staging Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "**Space:** ${{ secrets.HF_USERNAME }}/clinical-study-extraction-staging" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** develop" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://${{ secrets.HF_USERNAME }}-clinical-study-extraction-staging.hf.space" >> $GITHUB_STEP_SUMMARY

  # Job 4: Validate Deployment
  validate-deployment:
    name: Validate Deployment
    needs: deploy-production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: â³ Wait for Space to be ready
        run: |
          echo "â³ Waiting 60 seconds for Space to build and start..."
          sleep 60

      - name: ðŸ¥ Health Check
        run: |
          SPACE_URL="https://${{ secrets.HF_USERNAME }}-clinical-study-extraction.hf.space"
          
          echo "ðŸ” Checking health endpoint..."
          for i in {1..5}; do
            if curl -f -s "$SPACE_URL/health" > /dev/null; then
              echo "âœ… Health check passed!"
              curl -s "$SPACE_URL/health" | jq .
              exit 0
            fi
            echo "â³ Attempt $i failed, waiting 30 seconds..."
            sleep 30
          done
          
          echo "âŒ Health check failed after 5 attempts"
          exit 1

      - name: ðŸ“Š Test API Endpoints
        run: |
          SPACE_URL="https://${{ secrets.HF_USERNAME }}-clinical-study-extraction.hf.space"
          
          echo "ðŸ” Testing API documentation..."
          if curl -f -s "$SPACE_URL/docs" > /dev/null; then
            echo "âœ… API docs accessible"
          else
            echo "âš ï¸ API docs not accessible"
          fi
          
          echo "ðŸ” Testing OpenAPI schema..."
          if curl -f -s "$SPACE_URL/openapi.json" > /dev/null; then
            echo "âœ… OpenAPI schema accessible"
          else
            echo "âš ï¸ OpenAPI schema not accessible"
          fi

      - name: ðŸ“ Create validation summary
        if: success()
        run: |
          echo "## âœ… Deployment Validation Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All health checks passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Space is live and healthy!** ðŸŽ‰" >> $GITHUB_STEP_SUMMARY

  # Job 5: Rollback (Manual trigger only)
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ðŸ”„ Rollback to previous version
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          SPACE_NAME: clinical-study-extraction
        run: |
          set -e
          
          echo "ðŸ”„ Rolling back Space..."
          git clone https://huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME hf-space
          cd hf-space
          
          git log --oneline -n 5
          
          echo "ðŸ“¥ Checking out previous commit..."
          git reset --hard HEAD~1
          
          echo "ðŸš€ Pushing rollback..."
          git push --force https://USER:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME main
          
          echo "âœ… Rollback successful!"
          
          cd ..
          rm -rf hf-space

      - name: ðŸ’¬ Notify rollback
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ðŸ”„ Rollback triggered by ${{ github.actor }}
            Status: ${{ job.status }}
            Space: ${{ secrets.HF_USERNAME }}/clinical-study-extraction
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
