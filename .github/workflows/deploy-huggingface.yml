name: Deploy to Hugging Face Spaces

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  HF_SPACE_REPO: ${{ secrets.HF_USERNAME }}/clinical-study-extraction

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: üîç Run linting
        run: |
          pip install flake8
          flake8 backend/app --count --select=E9,F63,F7,F82 --show-source --statistics
        continue-on-error: true

      - name: üß™ Run tests
        run: |
          pip install pytest pytest-cov
          cd backend
          pytest tests/ --cov=app --cov-report=xml || true
        continue-on-error: true

  # Job 2: Deploy to Hugging Face Spaces (Production)
  deploy-production:
    name: Deploy to Hugging Face Spaces (Production)
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: üîç Validate secrets
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
        run: |
          if [ -z "$HF_USERNAME" ]; then
            echo "‚ùå Error: HF_USERNAME secret is not set!"
            echo ""
            echo "Please add the HF_USERNAME secret to your GitHub repository:"
            echo "1. Go to Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: HF_USERNAME"
            echo "4. Value: Your Hugging Face username (e.g., 'your-username')"
            echo ""
            echo "See GITHUB_ACTIONS_SETUP.md for detailed instructions."
            exit 1
          fi
          
          if [ -z "$HF_TOKEN" ]; then
            echo "‚ùå Error: HF_TOKEN secret is not set!"
            echo ""
            echo "Please add the HF_TOKEN secret to your GitHub repository:"
            echo "1. Go to https://huggingface.co/settings/tokens"
            echo "2. Create a new token with 'Write' access"
            echo "3. Go to GitHub Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "4. Click 'New repository secret'"
            echo "5. Name: HF_TOKEN"
            echo "6. Value: Your Hugging Face token"
            echo ""
            echo "See GITHUB_ACTIONS_SETUP.md for detailed instructions."
            exit 1
          fi
          
          echo "‚úÖ All required secrets are set"
          echo "HF_USERNAME: $HF_USERNAME"

      - name: ü§ó Deploy to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          SPACE_NAME: clinical-study-extraction
        run: |
          set -e
          
          echo "üîß Configuring git..."
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "GitHub Actions Bot"
          
          echo "üì• Cloning Hugging Face Space repository..."
          git clone https://huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME hf-space
          
          echo "üßπ Cleaning Space repository..."
          cd hf-space
          rm -rf backend/ Dockerfile README.md .gitignore || true
          
          echo "üìã Copying files to Space..."
          cp -r ../backend .
          cp ../Dockerfile.huggingface Dockerfile
          cp ../README_HUGGINGFACE.md README.md
          
          echo "‚úçÔ∏è Creating .gitignore..."
          cat > .gitignore << 'EOF'
          __pycache__/
          *.py[cod]
          *$py.class
          *.so
          .Python
          build/
          develop-eggs/
          dist/
          downloads/
          eggs/
          .eggs/
          lib/
          lib64/
          parts/
          sdist/
          var/
          wheels/
          *.egg-info/
          .installed.cfg
          *.egg
          .env
          .venv
          env/
          venv/
          ENV/
          env.bak/
          venv.bak/
          .DS_Store
          .idea/
          .vscode/
          *.swp
          *.swo
          *~
          uploads/
          exports/
          cache/
          *.log
          EOF
          
          echo "üìù Checking for changes..."
          git add .
          
          if git diff --staged --quiet; then
            echo "‚úÖ No changes to deploy"
          else
            echo "üöÄ Committing and pushing changes..."
            git commit -m "üöÄ Auto-deploy from GitHub Actions

          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Author: ${{ github.actor }}
          Message: ${{ github.event.head_commit.message }}"
            
            git push https://USER:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME main
            
            echo "‚úÖ Deployment successful!"
          fi
          
          cd ..
          rm -rf hf-space

      - name: üìù Create deployment summary
        if: success()
        run: |
          echo "## üöÄ Deployment to Hugging Face Spaces Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Space:** ${{ secrets.HF_USERNAME }}/clinical-study-extraction" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Access URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Space URL:** https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/clinical-study-extraction" >> $GITHUB_STEP_SUMMARY
          echo "- **API Endpoint:** https://${{ secrets.HF_USERNAME }}-clinical-study-extraction.hf.space" >> $GITHUB_STEP_SUMMARY
          echo "- **API Docs:** https://${{ secrets.HF_USERNAME }}-clinical-study-extraction.hf.space/docs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Build Info" >> $GITHUB_STEP_SUMMARY
          echo "- Build time: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

  # Job 3: Deploy to Staging Space (Develop branch)
  deploy-staging:
    name: Deploy to Staging Space (Develop)
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Validate secrets
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
        run: |
          if [ -z "$HF_USERNAME" ]; then
            echo "‚ùå Error: HF_USERNAME secret is not set!"
            echo ""
            echo "Please add the HF_USERNAME secret to your GitHub repository:"
            echo "1. Go to Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: HF_USERNAME"
            echo "4. Value: Your Hugging Face username (e.g., 'your-username')"
            echo ""
            echo "See GITHUB_ACTIONS_SETUP.md for detailed instructions."
            exit 1
          fi
          
          if [ -z "$HF_TOKEN" ]; then
            echo "‚ùå Error: HF_TOKEN secret is not set!"
            echo ""
            echo "Please add the HF_TOKEN secret to your GitHub repository:"
            echo "1. Go to https://huggingface.co/settings/tokens"
            echo "2. Create a new token with 'Write' access"
            echo "3. Go to GitHub Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "4. Click 'New repository secret'"
            echo "5. Name: HF_TOKEN"
            echo "6. Value: Your Hugging Face token"
            echo ""
            echo "See GITHUB_ACTIONS_SETUP.md for detailed instructions."
            exit 1
          fi
          
          echo "‚úÖ All required secrets are set"
          echo "HF_USERNAME: $HF_USERNAME"

      - name: ü§ó Deploy to Staging Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          SPACE_NAME: clinical-study-extraction-staging
        run: |
          set -e
          
          echo "üîß Configuring git..."
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "GitHub Actions Bot"
          
          echo "üì• Cloning Staging Space..."
          git clone https://huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME hf-staging || {
            echo "‚ö†Ô∏è Staging space doesn't exist, skipping..."
            exit 0
          }
          
          echo "üìã Copying files..."
          cd hf-staging
          rm -rf backend/ Dockerfile README.md || true
          cp -r ../backend .
          cp ../Dockerfile.huggingface Dockerfile
          cp ../README_HUGGINGFACE.md README.md
          
          echo "üöÄ Deploying to staging..."
          git add .
          git commit -m "üß™ Staging deploy from develop branch" || exit 0
          git push https://USER:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME main
          
          cd ..
          rm -rf hf-staging

      - name: üìù Create staging summary
        if: success()
        run: |
          echo "## üß™ Staging Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "**Space:** ${{ secrets.HF_USERNAME }}/clinical-study-extraction-staging" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** develop" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://${{ secrets.HF_USERNAME }}-clinical-study-extraction-staging.hf.space" >> $GITHUB_STEP_SUMMARY

  # Job 4: Validate Deployment
  validate-deployment:
    name: Validate Deployment
    needs: deploy-production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ‚è≥ Wait for Space to be ready
        run: |
          echo "‚è≥ Waiting 60 seconds for Space to build and start..."
          sleep 60

      - name: üè• Health Check
        run: |
          SPACE_URL="https://${{ secrets.HF_USERNAME }}-clinical-study-extraction.hf.space"
          
          echo "üîç Checking health endpoint..."
          for i in {1..5}; do
            if curl -f -s "$SPACE_URL/health" > /dev/null; then
              echo "‚úÖ Health check passed!"
              curl -s "$SPACE_URL/health" | jq .
              exit 0
            fi
            echo "‚è≥ Attempt $i failed, waiting 30 seconds..."
            sleep 30
          done
          
          echo "‚ùå Health check failed after 5 attempts"
          exit 1

      - name: üìä Test API Endpoints
        run: |
          SPACE_URL="https://${{ secrets.HF_USERNAME }}-clinical-study-extraction.hf.space"
          
          echo "üîç Testing API documentation..."
          if curl -f -s "$SPACE_URL/docs" > /dev/null; then
            echo "‚úÖ API docs accessible"
          else
            echo "‚ö†Ô∏è API docs not accessible"
          fi
          
          echo "üîç Testing OpenAPI schema..."
          if curl -f -s "$SPACE_URL/openapi.json" > /dev/null; then
            echo "‚úÖ OpenAPI schema accessible"
          else
            echo "‚ö†Ô∏è OpenAPI schema not accessible"
          fi

      - name: üìù Create validation summary
        if: success()
        run: |
          echo "## ‚úÖ Deployment Validation Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All health checks passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Space is live and healthy!** üéâ" >> $GITHUB_STEP_SUMMARY

  # Job 5: Rollback (Manual trigger only)
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: üîç Validate secrets
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
        run: |
          if [ -z "$HF_USERNAME" ]; then
            echo "‚ùå Error: HF_USERNAME secret is not set!"
            echo ""
            echo "Please add the HF_USERNAME secret to your GitHub repository:"
            echo "1. Go to Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: HF_USERNAME"
            echo "4. Value: Your Hugging Face username (e.g., 'your-username')"
            echo ""
            echo "See GITHUB_ACTIONS_SETUP.md for detailed instructions."
            exit 1
          fi
          
          if [ -z "$HF_TOKEN" ]; then
            echo "‚ùå Error: HF_TOKEN secret is not set!"
            echo ""
            echo "Please add the HF_TOKEN secret to your GitHub repository:"
            echo "1. Go to https://huggingface.co/settings/tokens"
            echo "2. Create a new token with 'Write' access"
            echo "3. Go to GitHub Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "4. Click 'New repository secret'"
            echo "5. Name: HF_TOKEN"
            echo "6. Value: Your Hugging Face token"
            echo ""
            echo "See GITHUB_ACTIONS_SETUP.md for detailed instructions."
            exit 1
          fi
          
          echo "‚úÖ All required secrets are set"
          echo "HF_USERNAME: $HF_USERNAME"

      - name: üîÑ Rollback to previous version
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          SPACE_NAME: clinical-study-extraction
        run: |
          set -e
          
          echo "üîÑ Rolling back Space..."
          git clone https://huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME hf-space
          cd hf-space
          
          git log --oneline -n 5
          
          echo "üì• Checking out previous commit..."
          git reset --hard HEAD~1
          
          echo "üöÄ Pushing rollback..."
          git push --force https://USER:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME main
          
          echo "‚úÖ Rollback successful!"
          
          cd ..
          rm -rf hf-space
