name: Deploy to VPS (Docker Compose)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ secrets.APP_URL }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

    - name: Create .env.production file
      run: |
        cat > .env.production << EOF
        # Backend Configuration
        ENVIRONMENT=production
        DEBUG=False
        HOST=0.0.0.0
        PORT=8000
        CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}
        SECRET_KEY=${{ secrets.SECRET_KEY }}
        MAX_FILE_SIZE=50000000
        LOG_LEVEL=INFO

        # External Services
        ENTREZ_EMAIL=${{ secrets.ENTREZ_EMAIL }}
        VITE_GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}

        # Frontend Configuration
        VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}
        VITE_ENABLE_AI_FEATURES=true
        VITE_ENABLE_BACKEND_EXTRACTION=true

        # Docker Configuration
        BACKEND_PORT=8000
        FRONTEND_PORT=80
        BACKEND_CPU_LIMIT=2
        BACKEND_MEMORY_LIMIT=2g
        FRONTEND_CPU_LIMIT=1
        FRONTEND_MEMORY_LIMIT=512m
        EOF

    - name: Copy files to VPS
      run: |
        ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "mkdir -p ${{ secrets.DEPLOY_PATH }}"
        rsync -avz --delete \
          --exclude '.git' \
          --exclude 'node_modules' \
          --exclude '__pycache__' \
          --exclude '*.pyc' \
          --exclude '.env*' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.DEPLOY_PATH }}/

        # Copy the environment file
        scp .env.production ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.DEPLOY_PATH }}/.env.production

    - name: Deploy with Docker Compose
      run: |
        ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
          cd ${{ secrets.DEPLOY_PATH }}

          # Pull latest images if any
          docker-compose -f docker-compose.prod.yml pull

          # Build and start containers
          docker-compose -f docker-compose.prod.yml up -d --build

          # Clean up old images
          docker image prune -f

          # Wait for services to be healthy
          echo "Waiting for services to start..."
          sleep 15

          # Check service status
          docker-compose -f docker-compose.prod.yml ps
        ENDSSH

    - name: Verify deployment
      run: |
        ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
          cd ${{ secrets.DEPLOY_PATH }}

          # Check backend health
          BACKEND_HEALTH=$(docker-compose -f docker-compose.prod.yml exec -T backend curl -f http://localhost:8000/health || echo "failed")
          if [[ $BACKEND_HEALTH == *"failed"* ]]; then
            echo "Backend health check failed!"
            exit 1
          fi
          echo "Backend is healthy"

          # Check frontend health
          FRONTEND_HEALTH=$(docker-compose -f docker-compose.prod.yml exec -T frontend wget -q -O - http://localhost/health || echo "failed")
          if [[ $FRONTEND_HEALTH == *"failed"* ]]; then
            echo "Frontend health check failed!"
            exit 1
          fi
          echo "Frontend is healthy"

          echo "Deployment verification successful!"
        ENDSSH

    - name: Cleanup
      if: always()
      run: |
        rm -f ~/.ssh/id_rsa
        rm -f .env.production

    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "✅ Deployment successful!"
        else
          echo "❌ Deployment failed!"
        fi

  rollback:
    name: Rollback (Manual)
    runs-on: ubuntu-latest
    if: failure()
    environment: production
    needs: deploy

    steps:
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

    - name: Rollback to previous version
      run: |
        ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
          cd ${{ secrets.DEPLOY_PATH }}

          # Rollback using docker-compose
          docker-compose -f docker-compose.prod.yml down
          git checkout HEAD~1
          docker-compose -f docker-compose.prod.yml up -d --build

          echo "Rolled back to previous version"
        ENDSSH

    - name: Cleanup
      if: always()
      run: rm -f ~/.ssh/id_rsa
